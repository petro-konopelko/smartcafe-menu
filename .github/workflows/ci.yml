name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  DOTNET_VERSION: '10.0.x'
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: smartcafe_menu_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore SmartCafe.Menu.sln

    - name: Build solution
      run: dotnet build SmartCafe.Menu.sln --configuration Release --no-restore

    - name: Run unit tests
      run: dotnet test tests/SmartCafe.Menu.UnitTests/SmartCafe.Menu.UnitTests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=unit-test-results.trx"

    - name: Run integration tests
      env:
        Database__Host: localhost
        Database__Port: 5432
        Database__Name: smartcafe_menu_test
        Database__Username: postgres
        Database__Password: postgres
        AzureStorage__AccountName: devstoreaccount1
        AzureStorage__ContainerName: menu-images-test
        AzureServiceBus__Namespace: test-namespace
        AzureServiceBus__TopicName: menu-events-test
      run: dotnet test tests/SmartCafe.Menu.IntegrationTests/SmartCafe.Menu.IntegrationTests.csproj --configuration Release --no-build --verbosity normal --logger "trx;LogFileName=integration-test-results.trx"

    - name: Publish test results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Test Results
        path: '**/*.trx'
        reporter: dotnet-trx
        fail-on-error: true

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: Restore dependencies
      run: dotnet restore SmartCafe.Menu.sln

    - name: Check code formatting
      run: dotnet format SmartCafe.Menu.sln --verify-no-changes --verbosity diagnostic

    - name: Run security scan
      uses: dotnet/nbgv@v0.4
      with:
        setAllVars: true
