name: CI

on:
  push:
    branches: [ main ]

jobs:
  # Build and test the code
  build-and-test:
    name: Build and Test
    uses: ./.github/workflows/build-and-test-template.yaml
    with:
      test-results-artifact-name: test-results

  # Publish test results
  publish-test-results:
    name: Publish Test Results
    runs-on: ubuntu-latest
    needs: build-and-test
    if: always()
    
    steps:
    - name: Download test results
      uses: actions/download-artifact@v4
      with:
        name: test-results
        path: test-results

    - name: Publish test report
      uses: dorny/test-reporter@v1
      with:
        name: Test Results
        path: 'test-results/**/*.trx'
        reporter: dotnet-trx
        fail-on-error: true

  # Security scanning
  security:
    name: Security Scan
    uses: ./.github/workflows/security-template.yaml
